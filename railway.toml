[build]
builder = "DOCKERFILE"

[deploy]
numReplicas = 1
restartPolicyType = "ON_FAILURE"
healthCheckPath = "/health"
healthCheckTimeout = 300

# Backend service
[[services]]
name = "backend"
sourcePath = "./backend"
healthCheckPath = "/health"
healthCheckTimeout = 300

[services.env]
ENVIRONMENT = "production"
REDIS_URL = "${REDIS_URL}"
R_SERVICE_URL = "http://r-service:8001"
FRONTEND_URL = "https://${RAILWAY_STATIC_URL}"

# Frontend service  
[[services]]
name = "frontend"
sourcePath = "./frontend"
healthCheckPath = "/"
healthCheckTimeout = 300

[services.env]
VITE_API_URL = "/api"
VITE_ENVIRONMENT = "production"

# R service
[[services]]
name = "r-service"
sourcePath = "./r_service"
healthCheckPath = "/health"
healthCheckTimeout = 300

[services.env]
REDIS_URL = "${REDIS_URL}"

# Celery worker
[[services]]
name = "celery-worker"
sourcePath = "./backend"
command = "celery -A app.celery worker --loglevel=info"

[services.env]
REDIS_URL = "${REDIS_URL}"
R_SERVICE_URL = "http://r-service:8001"
ENVIRONMENT = "production"